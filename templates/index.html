<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>èªéŸ³é©—è­‰æ”»é˜²æ¨¡æ“¬</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2em; background-color: #f5f5f5; }
    h1 { font-size: 28px; }
    button { font-size: 18px; margin: 10px; padding: 10px 20px; }
    audio { display: block; margin-top: 10px; }
    textarea, pre { width: 100%; margin-top: 10px; font-size: 16px; background: #fff; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; }
    label { font-size: 18px; margin-top: 20px; display: block; }
  </style>
</head>
<body>
  <h1>èªéŸ³èªè­‰å…¨æµç¨‹é¡¯ç¤º</h1>

  <label><input type="checkbox" id="mitmToggle"> å•Ÿç”¨ä¸­é–“äººæ”»æ“Š (MITM)</label>
  <button onclick="simulateTest()">ä½¿ç”¨ test.wav æ¨¡æ“¬æ¸¬è©¦</button>

  <audio id="audioPlayer" controls src="/static/audio/test.mp3"></audio>

  <textarea id="resultText" placeholder="èªéŸ³è½‰æ–‡çµæœ..."></textarea>

  <h3>ã€ğŸ”¹ Client ç™¼é€çš„å¯†æ–‡ã€‘</h3>
  <pre id="clientData">(ç­‰å¾…ä¸­...)</pre>

  <h3>ã€ğŸ”¸ MITM æ¡é›†åˆ°çš„åŸå§‹å¯†æ–‡ã€‘</h3>
  <pre id="mitmIntercept">(ç­‰å¾…ä¸­...)</pre>

  <h3>ã€ğŸ”¹ MITM ä¿®æ”¹å¾Œé‡é€çš„å¯†æ–‡ã€‘</h3>
  <pre id="mitmTampered">(ç­‰å¾…ä¸­...)</pre>

  <h3>ã€ğŸ”¸ Server æ¥æ”¶å¯†æ–‡èˆ‡é©—è­‰çµæœã€‘</h3>
  <pre id="serverResult">(ç­‰å¾…ä¸­...)</pre>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    function simulateTest() {
      const mitmEnabled = document.getElementById("mitmToggle").checked;
      document.getElementById("audioPlayer").play();
      fetch("/simulate", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mitm: mitmEnabled })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("resultText").value = data.transcript || "(ç„¡æ³•è¾¨è­˜èªéŸ³)";
      })
      .catch(err => {
        document.getElementById("resultText").value = "éŒ¯èª¤: " + err;
      });
    }

    const socket = io(`http://${window.location.hostname}:5000`);

    socket.on("message", (data) => {
      const parsed = JSON.parse(data);
      if (parsed.clientData) document.getElementById("clientData").textContent = JSON.stringify(parsed.clientData, null, 2);
      if (parsed.mitmIntercept) document.getElementById("mitmIntercept").textContent = JSON.stringify(parsed.mitmIntercept, null, 2);
      if (parsed.mitmTampered) document.getElementById("mitmTampered").textContent = JSON.stringify(parsed.mitmTampered, null, 2);
      if (parsed.serverResult) document.getElementById("serverResult").textContent = JSON.stringify(parsed.serverResult, null, 2);
    });
  </script>
</body>
</html>